<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Midnight Sun Firmware: Build System Documentation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">Midnight Sun Firmware
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_build_system.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Build System Documentation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >We use scons for our build system. We chose scons because it's written in python which is easier to understand than GNU make, and it's what Tesla uses for their build system.</p>
<h1><a class="anchor" id="autotoc_md6"></a>
Structure</h1>
<p >Source files are split up into a number of projects and libraries. The gist of how things work is that when you run <code>scons</code>, it first iterates over all projects and libraries to understand what can be built and generating the dependency tree. Then, it picks what to build based on your command arguments, and then builds it and its dependencies. All build artifacts are placed in the <code>build</code> directory.</p>
<p >Each project and library may also contain a <code>config.json</code> file with certain fields. This is used to control the way the project or library is built, like including various library dependencies.</p>
<p >Unit tests are per-project/library and are built and run from scons. Functions may be mocked by specifying which test file mocks which functions. An example of a mocking configuration is in the <code>core</code> library, in <code>config.json</code> and in <code>test/test_mock.c</code>.</p>
<h1><a class="anchor" id="autotoc_md7"></a>
Usage</h1>
<div class="fragment"><div class="line">scons [options]... &lt;command&gt; &lt;target&gt;</div>
<div class="line"> </div>
<div class="line">Options:</div>
<div class="line">options can occur anywhere in the command string</div>
<div class="line"> </div>
<div class="line">    --platform={x86|arm}    </div>
<div class="line">        Specifies target platform. One of `arm` or `x86`. Defaults to `arm` if not provided.</div>
<div class="line"> </div>
<div class="line">    --define=...</div>
<div class="line">        Add CPP defines to a build.</div>
<div class="line">        - e.g.`--define=&quot;LOG_LEVEL=LOG_LEVEL_WARN&quot;`</div>
<div class="line"> </div>
<div class="line">    --sanitizer={asan|tsan}</div>
<div class="line">        (x86) Specifies the sanitizer. One of `asan` for Address sanitizer or `tsan` for Thread sanitizer. Defaults to `none`.</div>
<div class="line">    </div>
<div class="line">    --test=&lt;test_name&gt;</div>
<div class="line">        Additionally specify the name of test to run for `test` command.</div>
<div class="line"> </div>
<div class="line">    --task=&lt;task_name&gt;</div>
<div class="line">        Specify a task to create for `new` command.</div>
<div class="line"> </div>
<div class="line">    --mem-report</div>
<div class="line">        (arm) Reports the memory space after a build</div>
<div class="line">    </div>
<div class="line">    --flash=&lt;application type&gt;</div>
<div class="line">        Specify whether we are flashing the bootloader, bootloader-application or raw application.</div>
<div class="line"> </div>
<div class="line">    --build-config=&lt;Build type&gt;</div>
<div class="line">        Specify if we are building in release or debug mode</div>
<div class="line"> </div>
<div class="line">    --compile-db=</div>
<div class="line">        Create a compile_commands.json for use with clangd</div>
<div class="line"> </div>
<div class="line">    --board=&lt;Board&gt;</div>
<div class="line">        Selects the build preset for a specific board.</div>
<div class="line"> </div>
<div class="line">Commands:</div>
<div class="line">    NONE</div>
<div class="line">        Build the specified target, or all target if not specified.</div>
<div class="line">        - e.g. `scons`</div>
<div class="line">        - e.g. `scons &lt;target&gt;` (`scons --project=leds`)</div>
<div class="line">        if the target is a python project, run the project.</div>
<div class="line"> </div>
<div class="line">    test</div>
<div class="line">        Test the specified target, or all target if not specified.</div>
<div class="line">        - e.g. `scons test`</div>
<div class="line">        - e.g. `scons test &lt;target&gt;` (`scons test --project=leds`)</div>
<div class="line">    </div>
<div class="line">    new</div>
<div class="line">        Creates a new project, smoke project, or library with the given name.</div>
<div class="line">        - e.g. `scons new &lt;target&gt;` (`scons new --project=new_led`)</div>
<div class="line">        if --task=&lt;task&gt; option is specified, instead create a new task within the target</div>
<div class="line">        - e.g. `scons new &lt;target&gt; --task=&lt;task_name&gt;` (`scons new --project=leds --task=led_task`)</div>
<div class="line"> </div>
<div class="line">    sim</div>
<div class="line">        (x86) Run the project&#39;s binary.</div>
<div class="line">        - e.g. `scons sim --platform=x86 &lt;target&gt;` (`scons sim --platform=x86 --project=new_led`)</div>
<div class="line"> </div>
<div class="line">    mpxe_server</div>
<div class="line">        (x86) Builds the MPXE simulation server</div>
<div class="line">        - e.g. &#39;scons mpxe_server&#39;</div>
<div class="line">    </div>
<div class="line">    sim mpxe_server</div>
<div class="line">        (x86) Run the MPXE simulation server</div>
<div class="line">        - e.g. &#39;scons sim mpxe_server&#39;</div>
<div class="line"> </div>
<div class="line">    mpxe_gui</div>
<div class="line">        (x86) Builds the MPXE simulation GUI</div>
<div class="line">        - e.g. &#39;scons mpxe_gui&#39;</div>
<div class="line"> </div>
<div class="line">    sim mpxe_gui</div>
<div class="line">        (x86) Run the MPXE simulation GUI</div>
<div class="line">        - e.g. &#39;scons sim mpxe_gui&#39;</div>
<div class="line"> </div>
<div class="line">    gdb</div>
<div class="line">        (x86) Run the project&#39;s binary with gdb.</div>
<div class="line">        - e.g. `scons gdb &lt;target&gt;`</div>
<div class="line"> </div>
<div class="line">        (arm) Start OpenOCD and connect GDB with TUI mode for on-target debugging.</div>
<div class="line">        Requires a controller board to be connected and powered.</div>
<div class="line">        - e.g. `scons gdb &lt;target&gt;`</div>
<div class="line"> </div>
<div class="line">    flash</div>
<div class="line">        (arm) Flash the project&#39;s binary using openocd. A controller board must be connected an powered.</div>
<div class="line">        - e.g. `scons flash &lt;target&gt;` (`scons flash --project=new_led`)</div>
<div class="line"> </div>
<div class="line">    format</div>
<div class="line">        Format a target, or all targets if not specified. uses autopep8 for python and clang-format for c.</div>
<div class="line">        - e.g. `scons format`</div>
<div class="line">        - e.g. `scons format &lt;target&gt;` (`scons format --project=new_led`)</div>
<div class="line"> </div>
<div class="line">    lint</div>
<div class="line">        Lint a target, or all targets if not specified. uses pylint for python and cpplint for c.</div>
<div class="line">        - e.g. `scons lint`</div>
<div class="line">        - e.g. `scons lint &lt;target&gt;` (`scons lint --project=new_led`)</div>
<div class="line"> </div>
<div class="line">    clean</div>
<div class="line">        Delete the `build` directory.</div>
<div class="line">    </div>
<div class="line">    hil</div>
<div class="line">        Runs a HIL test. This is not fully implemented yet</div>
<div class="line">    </div>
<div class="line">    doxygen</div>
<div class="line">        Build a local copy of the doxygen HTML</div>
<div class="line"> </div>
<div class="line">Target:</div>
<div class="line">targest can be specified with an option.</div>
<div class="line"> </div>
<div class="line">    --project=&lt;name&gt;</div>
<div class="line">        specify the target as a project with `name`</div>
<div class="line">        - e.g. `--project=leds`</div>
<div class="line"> </div>
<div class="line">    --library=&lt;name&gt;</div>
<div class="line">        specify the target as a library with `name`</div>
<div class="line">        - e.g. `--library=ms-common`</div>
<div class="line"> </div>
<div class="line">    --python=&lt;name&gt;` or --py=&lt;name&gt;</div>
<div class="line">        specify the target as a project with `name` (same as `--py=...`)</div>
<div class="line">        - e.g. `--python=example`, `--py=example`</div>
<div class="line"> </div>
<div class="line">    --smoke=&lt;name&gt;`</div>
<div class="line">        specify the target as a project with `name`, </div>
<div class="line">        - e.g. `--smoke=adc`</div>
<div class="line"> </div>
<div class="line">Convenience Commands:</div>
<div class="line">    &lt;name&gt;</div>
<div class="line">        build the target with the name</div>
<div class="line">        - e.g. `scons leds`</div>
<div class="line">        - e.g. `scons ms-common`</div>
<div class="line">    </div>
<div class="line">    &lt;path&gt;</div>
<div class="line">        build the target with the path. </div>
<div class="line">        - e.g. `scons projects/leds`</div>
<div class="line">        - e.g. `scons libraries/ms-common`</div>
<div class="line"> </div>
<div class="line">    test &lt;name&gt;/&lt;path&gt;</div>
<div class="line">        test the target with the name/path</div>
<div class="line">        - e.g. `scons test projects/leds`</div>
<div class="line">        (experimental, use at own risk)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md8"></a>
Future Improvements</h1>
<p >Features that would be nice to have in the future but haven't been done yet:</p><ul>
<li>gdb on arm</li>
<li>move the config.json schema into its own file </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5 </li>
  </ul>
</div>
</body>
</html>
